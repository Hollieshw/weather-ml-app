- name: Deploy DockerHub Image to Kubernetes via Minikube
  hosts: localhost
  become: yes
  become_user: ubuntu   # Run tasks as the ubuntu user

  vars:
    k8s_dir: /home/ubuntu/k8s
    docker_image: "hollieshw13/cwimage:latest"

  tasks:

    # ------------------ System Dependencies ------------------
    - name: Update APT cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install dependencies
      apt:
        name:
          - curl
          - apt-transport-https
          - docker.io
        state: present

    - name: Enable Docker service
      service:
        name: docker
        state: started
        enabled: yes

    # ------------------ Install Minikube ------------------
    - name: Download Minikube binary
      get_url:
        url: https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        dest: /home/ubuntu/minikube
        mode: '0755'

    - name: Add Minikube to PATH
      lineinfile:
        path: /home/ubuntu/.bashrc
        line: 'export PATH=$PATH:/home/ubuntu'
        state: present

    # ------------------ Start Minikube ------------------
 - name: Delete old Minikube cluster
      command: /home/ubuntu/minikube delete
      ignore_errors: yes

    - name: Start Minikube with Docker driver
      command: /home/ubuntu/minikube start --driver=docker
      become: no
      environment:
        CHANGE_MINIKUBE_NONE_USER: "true"

    - name: Wait for Kubernetes API to be ready
      command: kubectl get nodes
      register: kubectl_ready
      retries: 10
      delay: 6
      until: kubectl_ready.rc == 0
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    # ------------------ Kubernetes Deployment ------------------
    - name: Create Kubernetes directory
      file:
        path: "{{ k8s_dir }}"
        state: directory

    - name: Create deployment.yaml
      copy:
        dest: "{{ k8s_dir }}/deployment.yaml"
        content: |
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: myapp-deployment
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: myapp
            template:
              metadata:
                labels:
                  app: myapp
              spec:
                containers:
                - name: myapp
                  image: "{{ docker_image }}"
                  ports:
                  - containerPort: 80

    - name: Create service.yaml
      copy:
        dest: "{{ k8s_dir }}/service.yaml"
        content: |
          apiVersion: v1
          kind: Service
          metadata:
            name: myapp-service
          spec:
            type: NodePort
            selector:
              app: myapp
            ports:
              - port: 5000
                targetPort: 5000
                nodePort: 30080

    - name: Apply Deployment
      command: kubectl apply -f "{{ k8s_dir }}/deployment.yaml"
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Apply Service
      command: kubectl apply -f "{{ k8s_dir }}/service.yaml"
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: wait for pod to be ready
      command: kubectl wait --for=condition=ready pod -l app=myapp --timeout=30s

    - name: Get Kubernetes service URL
      command: minikube service myapp-service --url
      register: app_url
      ignore_errors: yes
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - debug:
        msg: "Application deployed! Access it at: {{ app_url.stdout }}"


